# Chapter 05. CPU 성능 향상 기법
## 5-2. 명령어 병렬 처리 기법
- **명령어 병렬 처리 기법(ILP: Instruction-Level Parallelism)**
  - 명령어를 동시에 처리하여 CPU를 한시도 쉬지 않고 작동시키는 기법
  - 대표적인 명령 병렬 처리 기법
    1. **명령어 파이브라이닝**
    2. **슈퍼스칼라**
    3. **비순차적 명령어 처리**

### 명령어 파이프라인
- 명령어 처리 과정을 클럭 단위로 나누어 본다.
  1. 명령어 인출(Instruction Fetch)
  2. 명령어 해석(Instruction Decode)
  3. 명령어 실행(Execute Instruction)
  4. 결과 저장(Write Back)
- 같은 단계가 겹치지만 않는다면 CPU는 '각 단계를 동시에 실행할 수 있다.'는 것이다.
  - 예를 들어 CPU는 한 명령어를 '인출'하는 동안에 다른 명령어를 '실행'할 수 있고, 한 명령어가 '실행'되는 동안에 연산 결과를 '저장'할 수 있다.
- 마치 공장 생산 라인과 같이 명령어들은 **명령어 파이프라인(instruction pipeling)** 에 넣고 동시에 처리하는 기법을 **명령어 파이프라이닝(instruction pipelining)** 이라고 한다.

#### 파이프라인 위험
- 파이프라이닝이 높은 성능을 가져오기는 하지만, 특정 상황에서는 성능 향상에 실패하는 경우도 있는데 이러한 상황을 **파이브라인 위험(pipeline hazard)** 부른다.
- 파이프라인 위험에는 크게 아래 세 가지가 있다.
  1. **데이터 위험(data hazard)**
     - 명령어 간 '데이터 의존성'에 의해 발생한다.
     - 모든 명령어를 동시에 처리할 수 없다.
     - 어떤 명령어는 이전 명령어를 끝까지 실행해야만 비로소 실행할 수 있는 경우가 존재한다.
     - 데이터 의존적인 두 명령어를 무작정 동시에 실행하려고 하면 파이프라인이 제데로 작동하지 않는 것을 **데이터 위험**이라고 한다.
  2. **제어 위험(control hazard)**
     - 주로 분기 등으로 인한 '프로그램 카운터의 갑작스러운 변화'에 의해 발생한다.
     - 기본적으로 프로그램 카운터는 '현재 실행 중인 명령어의 다음 주소'로 갱신된다.
     - 하지만 프로그램 실행 흐름이 바뀌어 명령어가 실행되면서 프로그램 카운터 값에 갑작스러운 변화가 생긴다면 명령어 파이프라인에 미리 가지고 와서 처리 중이었던 명령어들은 아무 쓸모가 없어지는데 이를 **제어 위험**이라 한다.
     - 참고로 이를 위해 사용하는 기술 중 하나가 **분기 예측(branch prediction)** 이다.
       - 분기 예측은 프로글매이 어디로 분기할지 미리 예측한 후 그 주소를 인출하는 기술이다.
  3. **구조적 위험(structural hazard)**
     - 명령어들을 겹쳐 실행하는 과정에서 서로 다른 명령어가 동시에, ALU, 레지스터 등과 같은 CPU 부품을 사용하려고 할 때 발생한다.
     - 구조적 위험은 **자원 위험(resource hazard)** 라고 부른다.

### 슈퍼 스칼라
- 파이프라이닝은 단일 파이프라인으로도 구현이 가능하지만, 오늘날 대부분 CPU에서는 여러 개의 파이프라인을 사용한다.
  - 이처럼 CPU 내부에 여러 개의 명령어 파이프라인을 포함한 구조를 **슈퍼 스칼라(superscalar)** 라고 한다.
- 명령어 파이프라인을 하나만 두는 것이 마치 공장 생상 라인을 한 개 두는 것과 같다면, 슈퍼스칼라는 공장 생산 라인을 여러개 두는 것과 같다.
- 슈퍼스칼라 구조로 명령어 처리가 가능한 CPU를 **슈퍼스칼라 프로세서** 또는 **슈퍼스칼라 CPU**라고 한다.
- 슈퍼스칼라 프로세서는 매 클럭 주기마다 동시에 여러 명령어를 인출할 수도, 실행할 수도 있어야 한다.
- 가령 멀티스레드 프로세서는 한 번에 여러 명령어를 인출하고, 해석하고, 실행할 수 있기 때문에 슈퍼스칼라 구조를 사용할 수 있다.
- 슈퍼스칼라 프로세서는 이론적으로 파이프라인 개수에 비례하여 프로그램 처리 속도가 빨라진다.
  - 하지만 파이프라인 위험 등의 예상치 못한 문제가 있어 실제로는 반드시 파이프라인 개수에 비례하여 빨리지지는 않는다.
  - 이 때문에 슈퍼스칼라 방식을 차용한 CPU는 파이프라인 위험을 방지하기 위해 고도로 설계되어야 한다.
  - 여러 개의 파이프라인을 이용하면 하나의 파이프라인을 사용할 때보다 데이터 위험, 제어 위험, 자원 위험을 피하기가 더욱 까다롭기 때문이다.

### 비순차적 명령어 처리
- **비순차적 명령어 처리(OoOE: Out-of-order execution)**
  - 명령어들을 순차적으로 실행하지 않는 기법(= '합법적인 새치기')
- 파이프라이닝, 슈퍼스칼라 기법은 모두 여러 명령어의 순차적인 처리를 상정한 방법이다.
  - 그러나 **비순차적 명령어 처리 기법**은 명령어를 순차적으로만 실행하지 않고 순서를 바꿔 실행해도 무방한 명령어를 먼저 실행하여 명령어 파이프라인이 멈추는 것을 방지하는 기법이다.
- 비순차적 명령어 처리가 가능한 CPU는 명령어들이 어떤 명령어와 데이터 의존성을 가지고 있는지, 순서를 바꿔 실행할 수 있는 명령어에는 어떤 것들이 있는지를 판단할 수 있어야 한다.

---