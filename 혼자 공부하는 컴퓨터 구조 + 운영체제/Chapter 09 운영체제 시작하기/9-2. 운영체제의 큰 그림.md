# Chapter 09 운영체제 시작하기
## 9-2. 운영체제의 큰 그림
- 운영체제는 사용자가 실행하는 응용 프로그램이 올바르게 실행되도록 돕고 필요한 자원을 할당해 주는 프로그램이다.
- 이번 절에서 운영체제에서 매우 중요한 개념인 **커널** 에 대해 알아보고 응용 프로그램이 운영체제로부터 어떻게 도움을 받으며 실행되는지를 이해하기 위해 **이중 모드** 와 **시스템 호출** 이라는 개념을 알아보자.

### 운영체제의 심장, 커널
- 운영체제는 현존하는 프로그램 중 규모가 가장 큰 프로그램 중 하나이다.
- 운영체제가 응용 프로그램에 제공하는 서비스 종류는 다양하지만, 그중에서도 가장 핵심적인 서비스가 있다.
  - 자원에 접근하고 조작하는 기능, 프로그램이 올바르고 안전하게 실행되게 하는 기능이 운영체제의 핵심 서비스에 속한다.
    - 이러한 운영체제의 핵심 서비스를 담당하는 부분을 **커널(kernel)** 이라고 한다.
- 운영체제가 설치된 모든 기기에는 커널이 있다. 
  - 커널은 마치 사람의 심장, 혹은 자동차의 엔진과도 같다.
  - 어떤 커널을 사용하는지에 따라 우리가 실행하고 개발하는 프로그램이 하드웨어를 이용하는 양상이 달라지고, 결과적으로 컴퓨터 전체의 성능도 달라질 수 있다.
- 운영체제가 제공하는 서비스 중 커널에 포함되지 않은 서비스도 있는데, 대표적으로 사용자 인터페이스가 있다.
  - **사용자 인터페이스(UI: User Interface)** 는 윈도우의 바탕화면과 같이 사용자가 컴퓨터와 상호작용할 수 있는 통로이다.
- 운영체제가 제공하는 사용자 인터페이스의 종류에는 **그래픽 유저 인터페이스(GUI: Graphical User Interface)** 와 **커멘드 라인 인터페이스(CLI: Command Line Interface)** 가 있다.
  - 전자는 윈도우 바탕화면이나 스마트폰의 화면처럼 그래픽을 기반으로 컴퓨터와 상호작용할 수 있는 인터페이스이고, 후자는 명령어를 기반으로 컴퓨터와 상호작용할 수 있는 인터페이스이다.

### 이중 모드와 시스템 호출
- 운영체제는 사용자가 실행하는 응용 프로그램이 하드웨어 자원에 직접 접근하는 것을 방지하여 자원을 보호한다.
  - 만약 응용 프로그램이 CPU, 메모리, 하드 디스크 등에 마음대로 접근하고 조작할 수 있다면 자원이 무질서하게 관리될 것이고 응용 프로그램이 조금만 실수해도 컴퓨터 전체에 큰 악영향을 끼칠 수 있다.
- 그래서 운영체제는 응용 프로그램들이 자원에 접근하려고 할 때 오직 자신을 통해서만 접근하도록 하여 자원을 보호한다.
  - 비유하자면 운영체제는 응용 프로그램의 자원 접근을 대행하는 일종의 문지기 역할을 한다.
  - 응용 프로그램이 자원에 접근하기 위해서는 운영체제에 도움을 요청해야 한다.
  - 이때 '운영체제에 도움을 요청한다'는 말은 '운영체제 코드를 실행하려고 한다'는 말과 같다.
  - 응용 프로그램의 요청을 받는 운영체제는 응용 프로그램 대신 자원에 접근하여 요청한 작업을 수행한다.
- 예를 들어 응용 프로그램이 실행 과정에서 하드 디스크에 접근하여 데이터를 저장하려면 운영체제에 도움을 요청해야 하고, 운영체제는 커널 영역 내의 하드 디스크에 데이터를 저장하는 코드를 실행하여 응용 프로그램의 작업을 대신 수행해준다.
- 이러한 운영체제의 문지기 역할은 이중 모드로써 구현된다.
  - **이중 모드(dual mode)** 란 CPU가 명령어를 실행하는 모드를 크게 사용자 모드와 커널 모드로 구분하는 방식이다.
  - CPU는 명령어를 사용자 모드로써 실행할 수 있고, 커널 모드로써 실행할 수 있다.
- **사용자 모드(user mode)** 는 운영체제 서비스를 제공받을 수 없는 실행 모드이다.
  - 즉, 커널 영역의 코드를 실행할 수 없는 모드이다.
  - 일반적인 응용 프로그램은 기본적으로 사용자 모드로 실행된다.
  - 사용자 모드로 실행 중인 CPU는 입출력 명령어와 같이 하드웨어 자원에 접근하는 명령어를 실행할 수 없다.
  - 그래서 사용자 모드로 실행되는 일반적인 응용 프로그램은 자원에 접근할 수 없다.
- 반면 **커널모드(kernel mode)** 는 운영체제 서비스를 제공받을 수 있는 실행 모드이다.
  - 즉, 커널 영역의 코드를 실행할 수 있는 모드이다.
  - CPU가 커널 모드로 명령어를 실행하면 자원에 접근하는 명령어를 비롯한 모든 명령어를 실행할 수 있다.
  - 운영체제는 커널 모드로 실행되기 때문에 자원에 접근 할 수 있다.
- 요컨대 사용자 모드로 실행되는 프로그램이 자원에 접근하는 운영체제 서비스를 제공받으려면 운영체제에 요청을 보내 커널 모드로 전환되어야 한다.
  - 이때 운영체제 서비스를 제공받기 위한 요청을 **시스템 호출(system call)** 이라고 한다.
  - 사용자 모드로 실행되는 프로그램은 시스템 호출을 통해 커널 모드로 전환하여 운영체제 서비스를 제공받을 수 있다.
- 시스템 호출은 일종의 인터럽트이다.
  - 정확히는 소프트웨어적인 인터럽트이다.
  - 인터럽트는 입출력장치에 의해 발생하기도 하지만 인터럽트를 발생시키는 특정 명령어에 의해 발생하기도 하는데 이를 **소프트웨어 인터럽트** 라고 한다.
- 시스템 호출을 발생시키는 명령어가 실행되면 CPU는 지금까지의 작업을 백업하고, 커널 영역 내에 시스템 호출을 수행하는 코드(인터럽트 서비스 루틴)를 실행한 뒤 다시 기존에 실행하던 응용 프로그램으로 복귀하여 실행을 계속해 나간다.
  - 시스템 호출의 작동 예시
    - 한 응용 프로그램이 하드 디스크에 데이터를 저장하려 한다고 가정해보자.
    - 이를 위해 응용 프로그램은 하드 디스크에 접근해야한다.
      - 하지만 사용자 모드로 실행되는 동안에는 자원(하드 디스크)에 접근할 수 없기에 커널 모드로 전환해야 한다.
    - 작동 방법
      1. 이를 위해 응용 프로그램은 하드 디스크에 데이터를 저장하는 시스템 호출을 발생시켜 커널 모드로 전환한다.
      2. 운영체제 내의 '하드 디스크에 데이터를 저장하는 코드'를 실행함으로써 하드 디스크에 접근할 수 있다.
      3. 그리고 하드 디스크의 접근이 끝났다면 다시 사용자 모드로 복귀하여 실행을 계속 해 나간다.

### 운영체제의 핵심 서비스
#### 프로세스 관리
- 실행 중인 프로그램을 **프로세스(process)** 라고 한다.
  - 이처럼 컴퓨터를 사용하는 동안 메모리 안에서는 새로운 프로세스들이 마구 생성되고, 사용되지 않는 프로세스는 메모리에서 삭제된다.
- 일반적으로 하나의 CPU는 한 번에 하나의 프로세스만 실행할 수 있기에 CPU는 이 프로세스들은 조금씩 번갈아 가며 실행한다.
  - 즉, CPU는 한 프로세스를 실행하다가 다른 프로세스로 실행을 전환하고, 그 프로세스를 실행하다가 또 다른 프로세스를 실행을 전환하는 것을 반복한다.
- 이때 각 프로세스는 상태도, 사용하고자 하는 자원도 다양하다.
  - 입출력장치를 주로 사용하는 프로세스도 있고, 입출력장치는 거의 사용하지 않고 주로 CPU만 사용하는 프로세스도 있다.
  - 또, 당장 실행할 수 있는 프로세스가 있는 반면, 당장 실행이 불가능한 프로세스도 있다.
- 여러 프로세스가 동시에 실행되는 환경에서는 '프로세스 동기화'가 필수적이고, 프로세스가 꼼짝도 못하고 더 이상 실행되지 못하는 상황인 '교착 상태'를 해결해야 한다.

#### 자원 접근 및 할당
- 모든 프로세스는 실행을 위해 자원을 필요로 한다.
  - 그리고 운영체제는 프로세스들이 사용할 자원에 접근하고 조작함으로써 프로세스에 필요한 자원을 할당해 준다.
- **CPU**
  - 일반적으로 메모리에는 여러 프로세스가 적재되고, 하나의 CPU는 한 번에 하나의 프로세스만 실행할 수 있다.
    - 그래서 하나의 프로세스가 CPU를 이용하고 있다면 다른 프로세스는 기다려야 한다.
    - 이에 운영체제는 프로세스들에 공정하게 CPU를 할당하기 위해 어떤 프로세스부터 CPU를 이용하게 할 것인지, 얼마나 오래 CPU를 이용하게 할지를 결정해야 한다.
      - 이를 **CPU 스케줄링** 이라 한다.
- **메모리**
  - 메모리에 적재된 프로세스들은 크기도, 적재되는 주소도 가지각색이다.
    - 같은 프로세스라 할지라도 실행할 때마다 적재되는 주소가 달라질 수 있다.
    - 그래서 운영체제는 새로운 프로세스가 적재될 때마다 어느 주소에 적재해야 할지를 결정해야 한다.
  - 때로는 메모리가 이미 꽉 차 있어 꼭 실행해야할 프로세스를 적재할 공간이 없는 경우도 있고, 메모리에 공간이 남았는 데도 불구하고 프로세스를 적재하지 못하는 상황도 발생한다.
- **입출력장치**
  - 인터럽트 서비스 루틴은 운영체제가 제공하는 기능으로 커널 영역에 있다.
    - 입출력장치가 발생시키는 하드웨어 인터럽트도 마찬가지이다.
    - 입출력장치가 CPU에 하드웨어 인터럽트 요청 신호를 보내면 CPU는 하던 일을 잠시 백업한 뒤 커널 영역에 있는 인터럽트 서비스 루틴을 실행한다.
    - 이처럼 운영체제는 인터럽트를 처리하는 프로그램, 즉 인터럽트 서비스 루틴을 제공함으로써 입출력 작업을 수행한다.

#### 파일 시스템 관리
- 컴퓨터를 사용할 때는 여러 파일을 열고, 생성하고, 삭제하곤 한다. 그리고 이 파일들을 한 곳에 묶어 디렉터리(폴더)로 관리한다.
  - 이렇게 당연해 보이는 이런 **파일 시스템(file system)** 도 운영체제가 지원하는 핵심 서비스이다.

### 정리
- 운영체제의 핵심 서비스를 제공하는 부분을 커널이라 한다.
- 그리고 사용자 프로세스가 커널의 서비스를 제공받이 위해서는(커널 영역의 코드를 실행하기 위해서는) 사용자 모드에서 커널 모드로 전환해야 하고, 이는 시스템 호출을 통해 이루어진다.
- 즉, 시스템 호출은 커널 모드로써 운영체제의 서비스를 제공 받을 수 있는 방법이다.

> #### 좀 더 알아보기) 가상 머신과 이중 모드의 발전
> - 이중 모드는 커널 모드와 사용자 모드, 두 가지 모드를 지원하는 실행 모드이지만, 가상 머신을 통한 가상화를 지원하는 현대 CPU는 두 가지 모드 이상을 지원한다.
>   - **가상 머신(virtual machine)** 이란 이름 그래도 소프트웨어적으로 만들어낸 가상 컴퓨터이다.
> - 우리의 컴퓨터에 설치된 운영체제에서 가상 머신을 설치 및 실행한다면, 그 가상 머신 또한 응용프로그램이기에 사용자 모드로 작동한다.
>   - 마찬가지로 가상 머신상에 설치된 운영체제 또한 사용자 모드로 작동한다.
>   - 가상 머신에 설치된 응용 프로그램이 운영체제 서비스를 제공받기 위해서는 커널 모드로 전환되어야 하는데, 가상 머신에 설치된 운영체제도 사용자 모드로 작동하면 운영체제 서비스를 제공받기 어렵겠죠?
>     - 가상화를 지원하는 CPU는 커널 모드와 사용자 모드 이외에 가상 머신을 위한 모드인 하이퍼 바이저모드를 따로 둔다.
>     - 이로써 가상 머신 상에서 작동하는 응용 프로그램들은 하이퍼바이저 모드로써 가상 머신에 설치된 운영체제로부터 운영체제 서비스를 받을 수 있다.
---
