# Chapter 04. CPU의 작동 원리
## 4-3. 명령어 사이클과 인터럽트
- CPU가 하나의 명령어를 처리하는 과정에는 어떤 정해진 흐름이 있고, CPU는 그 흐름을 반복하여 명령어들을 처리해 나간다.
  - 이렇게 하나의 명령어를 처리하는 정형화된 흐름을 **명령어 사이클** 이라고 한다.
- CPU는 정해진 흐름에 따라 명령어를 처리해 나가지만, 간혹 이 흐름이 끊어지는 상황이 발생하는데 이를 **인터럽트** 라고 한다.

### 명령어 사이클
- 실행하는 프로그램들은 수많은 명령어로 이루어져 있고, CPU는 이 명령어들을 하나씩 실행한다.
  - 이때 프로그램 속 각각의 명령어들은 일정한 주기가 반복되며 실행되는데, 이 주기를 **명령어 사이클(instruction cycle)** 이라 한다.
  - 즉, 프로그램 속 각각의 명령어들은 명령어 사이클이 반복되며 실행된다.
- 명령어 사이클의 과정
  1. 명령어를 메모리에서 CPU로 가져온다.
     - 메모리에 있는 명령어를 CPU로 가지고 오는 단계를 **인출 사이클(fetch cycle)**dlfkrh gksek.
  2. CPU로 명령어를 인출했다면 이제 명령어를 실행한다.
     - CPU로 가져온 명령어를 실행하는 단계를 **실행 사이클(execution cycle)**이라고 한다.
     - 제어 장치가 명령어 레지스터에 담긴 값을 해석하고, 제어 신홀르 발생시키는 단계가 실행 사이클이다.
  - 프로그램을 이루는 수많은 명령어는 일반적으로 인출과 실행 사이클을 반복하며 실행됩니다.
  - 즉, CPU는 프로그램 속 명령어를 가져오고 실행하고, 또 가져오고 실행하고를 반복한다.
  - 하지만, 모든 명령어가 간단히 실행되지는 않는다.
    - 명령어를 인출하여 CPU로 가져왔다 하더라고 곧바로 실행할 수 없는 경우도 있기 때문이다.
    - EX) 간접 주소 지정 방식
      - 간접 주소 지정 방식은 오퍼랜드 필드에 유효 주소의 주소를 명시한다.
      - 이 경우 명령어를 인출하여 CPU로 가져왔다 하더라도 바로 실행 사이클에 돌입할 수 없다.
      - 명령어를 실행하기 위해서는 메모리 접근을 한번 더 해야 하기 때문이다.
        - 이 단계를 **간접 사이클(indirect cycle)** 이라고 한다.

### 인터럽트
- 인터럽트(interrupt)
  - CPU가 수행 중인 작업은 방해를 받아 잠시 중단될 수 있는데, 이렇게 CPU의 작업을 방해하는 신호를 **인터럽트** 라고 한다.
- 인터럽트의 종류
  - **동기 인터럽트(synchronous interrupts)**
    - CPU에 의해 발생하는 인터럽트이다.
    - CPU가 명령어들을 수행하다가 예상치 못한 상황에 마주쳤을 때, 가령 CPU가 실행하는 프로그래밍상의 오류와 같은 예외적인 상황에 마주쳤을 때 발생하는 인터럽트가 동기 인터럽트이다.
    - 이런 점에서 동기 인터럽트를 **예외(exception)** 이라고 한다.
  - **비동기 인터럽트(asynchronous interrupts)**
    - 입출력장치에 의해 발생하는 인터럽트
    - EX)
      1. CPU가 프린터와 같은 입출력장치에 입출력 작업을 부탁하면 작업을 끝낸 입출력장치가 CPU에 완료 알림(인터럽트)을 보낸다.
      2. 키보드, 마우스 같은 입출력장치가 어떠한 입력을 받아들였을 때 이를 처리하기 위해 CPU에 입력 알림(인터럽트)을 보냅니다.
    - 일반적으로 비동기 입터럽트를 입터럽트라 칭하기도 하지만 혼동 방지를 위해 **하드웨어 인터럽트** 라고 칭하겠다.
    
#### 하드웨어 인터럽트
- 알림과 같은 인터럽트이다.
- CPU는 입출력 작업 도중에도 효율적으로 명령어를 처리하기 위해 이전 알림과 같은 하드웨어 인터럽트를 사용한다.

#### 하드웨어 인터럽트 처리 순서
- CPU가 하드웨어 인터럽트를 처리하는 순서
  1. 입출력장치는 CPU에 **인터럽트 요청 신호**를 보낸다.
  2. CPU는 실행 사이클이 끝나고 명령어를 인출하기 전 항상 인터럽트 여부를 확인한다.
  3. CPU는 인터럽트 요청을 확인하고 **인터럽트 플래그**를 통해 현재 인터럽트를 받아들일 수 있는지 여부를 확인한다.
  4. 인터럽트를 받아들일 수 있다면 CPU는 지금까지의 작업을 백업한다.
  5. CPU는 **인터럽트 벡터**를 참조하여 **인터럽트 서비스 루틴**을 실행한다.
  6. 인터럽트 서비스 루틴 실행이 끝나면 4.에서 백업해 둔 작업을 복구하여 실행을 재개한다.
- 키워드
  - **인터럽트 요청 신호**
    - 인터럽트는 CPU의 정상적인 실행 흐름을 끊는 것이기에 다른 누군가가 인터럽트하기 전에는 "지금 끼어도 되나요?"라고 CPU에 물어봐야 한다. 이를 인터럽트 요청 신호라 한다.
  - **인터럽트 플래그(interrupt flag)**
    - 말 그대로 하드웨어 인터럽트를 받아들일지, 무시할지를 결정하는 플래그이다. 
    - 인터럽트 요청 신호가 발생할 때, CPU가 인터럽트 요청을 수용하기 위해서는 플래그 레지스터의 인터럽트 플래그가 활성화되어 있어야 한다.
    - 다만, 모든 하드웨어 인터럽트를 인터럽트 플래그로 막을 수 있는 것은 아니다.
      - 인터럽트 플래그가 불가능으로 설정되어 있어도 무시할 수 없는 인터럽트 요청도 존재한다.
      - 무시할 수 없는 하드웨어 인터럽트는 가장 우선 순위가 높은, 다시 말해 반드시 가장 먼저 처리해야 하는 인터럽트이다.
  - **인터럽트 서비스 루틴(ISR: Interrupt Service Routine)(= 인터럽트 핸들러(interrupt handler))**
    - CPU가 인터럽트 요청을 받아들이기로 했다면 CPU는 인터럽트 서비스 루틴이라는 프로그램을 실행한다.
    - 인터럽트 서비스 루틴은 인터럽트를 처리하기 위한 프로그램이다.
    - 인터럽트 서비스 루틴은 '키보드가 어떤 인터럽트 요청을 보냈을 때는 어떻게 작동한다', '마우스가 어떤 인터럽트 요청을 보냈을 때는 어떻게 작동한다', '프로그램에 어떤 문제가 생겼을 때는 어떻게 작동한다'와 같이 어떤 인터럽트가 발생했을 때 해당 인터럽트를 어떻게 처리하고 작동해야 할지에 대한 정보로 이루어진 프로그램이다.
    - 인터럽트를 처리하는 방법은 입출력장치마다 다르므로 각기 다른 인터럽트 서비스 루틴을 가지고 있다.
      - 즉, 메모리에는 여러 개의 인터럽트 서비스 루틴이 저장되어 있다.
      - 이들 하나하나가 '인터럽트가 발생하면 어떻게 행동해야 할지를 알려주는 프로그램'이라 생각하면 된다. 
  - **인터럽트 벡터**
    - 인터럽트 서비스 루틴을 식별하기 위한 정보이다.
    - 인터럽트 벡터를 통해 인터럽트 서비스 루틴의 시작 주소를 알 수 있어 CPU는 특정 인터럽트 서비스 루틴을 처음부터 실행할 수 있다.
    - CPU는 수많은 인터럽트 서비스 루틴을 구분하기 위해 인터럽트 벡터를 이용한다.
  - 정리
    - 'CPU가 인터럽트를 처리한다' == '인터럽트 서비스 루틴을 실행하고, 본래 수행하던 작업으로 다시 되돌아온다.'라는 말과 같다.
  - 키워드 정리
    - 인터럽트 요청 신호: CPU의 작업을 방해하는 인터럽트에 대한 요청
    - 인터럽트 플래그: 인터럽트 요청 신호를 받아들일지 무시할지를 결정하는 비트
    - 인터럽트 벡터: 인터럽트 서비스 루틴의 시작 주소를 포함하는 인터럽트 서비스 루틴의 식별 정보
    - 인터럽트 서비스 루틴: 인터럽트를 처리하는 프로그램

### 좀 더 알아보기. 예외의 종류
- **예외**가 발생하면 CPU는 하던 일을 중단하고 해당 예외를 처리한다. 
- 예외를 처리하고 나면 CPU는 본래 하던 작업으로 되돌아와 실행을 재개한다.
- 예외의 종류
  1. **폴트(fault)**
     - 예외를 처리한 직후 예외가 발생한 명령어로부터 실행을 재개하는 예외이다.
  2. **트랩(trap)**
     - 예외를 처리한 직후 예외가 발생한 명령어의 다음 명령어부터 실행을 재개하는 예외이다.
     - EX) 디버깅(debugging)
  3. **중단(abort)**
     - CPU가 실행 중인 프로그램을 강제로 중단시킬 수밖에 없는 심각한 오류를 발견했을 때 발생하는 예외이다.
  4. **소프트웨어 인터럽트(software interrupt)**
     - 시스템 호출이 발생했을 때 나타난다.
---
