# Chapter 13 교착 상태
## 13-1. 교착 상태란
- 도심 속 도로에서 차가 꽉 막혀 꼼짝달싹 못하는 상황의 경우 교통이 마비되어 버리면서 복구되기까지 오랜 시간이 걸릴뿐더러, 심한 경우 교통 경찰이 직접 와서 마비를 해결해야 한다.
  - 프로세스 실행과정도 이와 비슷한 문제가 있다.
  - 프로레스를 실행하기 위해서는 자원이 필요한데, 두 개 이상의 프로세스가 각자 가지고 있는 자원을 무작정 기다린다면 그 어떤 프로세스도 더 이상 진행할 수 없는 교착 상태가 된다.

### 식사하는 철학자 문제
- **식사하는 철학자 문제(dining philosophers problems)** 는 교착 상태를 설명하기 위한 아주 고전적이고 재미있는 문제 상황이다.
  - 이 유명한 문제는 교착 상태가 어떤 상황에서 왜 발생하는지, 나아가 교착 상태를 어떻게 해결할 수 있는지를 엿볼 수 있는 가상의 문제 시나리오입니다.
- 동그란 원탁에 다섯 명의 철학자가 앉아 있고, 철학자들 앞에 맛있는 식사가 있고, 철학자들 사이에는 식사에 필요한 포크가 있다.
- 이 철학자들은 아래와 같은 순서대로 식사한다.
  1. 계속 생각을 하다가 왼쪽 포크가 사용 가능하면 집어든다.
  2. 계속 생각을 하다가 오른쪽 포크가 사용 가능하면 집어든다.
  3. 왼쪽과 오른쪽 포크를 모두 집어들면 정해진 시간동안 식사를 한다.
  4. 식사 시간이 끝나면 오른쪽 포크를 내려놓는다.
  5. 오른쪽 포크를 내려놓은 뒤 왼쪽 포크를 내려놓는다.
  6. 다시 (i)번 부터 반복한다.
- 과연 이 철학자들은 식사를 무사히 마칠 수 있을까?
  - 하지만 모든 철학자가 동시에 포크를 집어 식사를 하면 어떤 철학자도 식사를 할 수 없고 영원히 생각만 하는 상황이 발생한다.
  - 모든 철학자가 왼쪽 포크를 집어들면 모두가 오른쪽 포크를 집어 들 수 없기 때문이다.
- 이렇게 일어나지 않을 사건을 기다리며 진행이 멈춰 버리는 현상을 **교착 상태(deadlock)** 라고 한다.
- 식사하는 철학자 문제에서 철학자는 프로세스 혹은 스레드, 포크는 자원, 생각하는 행위는 자원을 기다리는 것에 빗대어 볼 수 있다.
  - 그리고 포크는 한 번에 하나의 프로세스 혹은 스데르만 접근할 수 있으니 임계 구역이라 볼 수 있다.
- 이는 마치 게임 프로세스는 자원 A를 점유한 채 웹 브라우저 프로세스가 점유하고 있는 자원 B의 사용이 끝나길 기다리고, 웹 브라우저 프로세스는 자원 B를 점유한 채 게임 프로세스의 자원 A 사용이 끝나길 기다리는 상황과 같다.
  - 이 경우 게임과 웹 브라우저 프로세스는 상대방이 가진 자원을 기다리기만 하다가 결국 실행 한 번 못하는 상황이 벌어진다.
  - 이를 교착 상태라고 한다. 
- 이러한 교착 상태를 해결하기 위해서는
  1. 교착 사태가 발생했을 때의 상황을 정확히 표현해 보고,
  2. 교착 상태가 일어나는 근본적인 이유에 대해 알아야 한다.

### 자원 할당 그래프
- 교착 상태는 **자원 할당 그래프(resource-allocation graph)** 를 통해 단순하게 표현할 수 있다.
  - 자원 할당 그래프는 어떤 프로세스가 어떤 자원을 사용하고 있고, 또 어떤 프로세스가 어떤 자원을 기다리고 있는지를 표현하는 간단한 그래프이다.
- 자원 할당 그래프는 아래와 같은 규칙을 그려진다.
1. **프로세스는 원으로, 자원을 종류는 사각형으로 표현한다.**
2. **사용할 수 있는 자원의 개수는 자원 사각형 내에 점으로 표현한다.**
  - 같은 자원이라 할지라도 사용 가능한 자원의 개수는 여러 개 있을 수 있다.
  - 예를 들어, 하드 디스크가 세 개 있는 경우 자원의 종류는 하드 디스크 하나이지만, 사용 가능한 하드 디스크 개수는 세 개이다.
    - 따라서 하드 디스크는 사각형 안에 세 개의 점으로 표현한다.
  - 또한 CPU가 두 개 있는 경우 자원의 종류는 CPU 하나이지만, 사용 가능한 CPU 개수는 두 개이므로 CPU 사각형 안에 두 개의 점으로 표현한다.
3. **프로세스가 어떤 자원을 할당받아 사용 중이라면 자원에서 프로세스를 향해 화살표를 표시한다.**
4. **프로세스가 어떤 자원을 기다리고 있다면 프로세스에서 자원으로 화살표를 표시한다.**
- 교착 상태가 발생한 상황은 자원 할당 그래프가 원의 형태를 띄고 있다.

### 교착 상태 발생 조건
- 교착 상태가 발생하는 조건
  - 아래 조건 중 하나라도 만족하지 않는다면 교착 상태가 발생하지 않지만, 아래 조건이 모두 만족될 때 교착 상태가 발생할 가능성이 생긴다고 보면 된다.
    1. **상호 배제**
       - 우선 교착 상태가 발생한 근본적인 원인은 해당 자원을 한 번에 하나의 프로세스만 이용 가능했기 때문이다.
         - 만일 식사하는 철학자 문제에서 하나의 문제에서 하나의 포크를 여러 명이 동시에 사용할 수 있었다면 교착상태를 발생하지 않았을 것이다.
       - 프로세스도 마찬가지로한 프로세스가 사용하는 자원을 다른 프로세스가 사용할 수 없을 때, 즉 **상호 배제(mutual exclusion)** 상황에서 교착 상태가 발생할 수 있다.
    2. **점유와 대기**
       - 식사하는 철학자 문제에도 누구도 식사를 이어나갈 수 없었던 이유는 '왼쪽 포크를 들고' 다른 철학자의 포크를 기다렸기 때문이다.
       - 다시 말해 자원을 보유한 채 다른 자원을 기다렸기 때문에 문제가 발생했다.
       - 프로세스도 마찬가지로 어떠한 자원을 할당받은 상태에서 다른 자원을 할당받기를 기다린다면 교착 상태가 발생할 수 있다.
       - 이렇게 '자원을 할당받은 상태에서 다른 자원을 할당받기를 기다리는 상태'를 **점유와 대기(hold and wait)** 라고 한다.
    3. **비선점**
       - 만일 철학자들 중 누군가가 다른 철학자의 포크를 강제로 빼앗을 수 있었다면 교착 상태는 발생하지 않았을 것이다.
         - 하지만 식사하는 철학자 문제에서 철학자들은 점잖게그저 포크를 기다리기만 했다.
       - 이처럼 교착 상태가 발생하게 된 또 하나의 근본적인 문제는 프로세스가 자원을 **비선점(non-preemptive)** 하고 있었기 떄문이다.
         - 비선점 자원은 그 자원을 이용하는 프로세스의 작업이 끝나야만 비로소 이용할 수 있다.
         - 즉, 어떤 프로세스도 다른 프로세스의 자원을 강제로 빼앗지 못했기 때문에 교착 상태가 발생했다고 볼 수 있다.
    4. **원형 대기**
      - 교착 상태가 발생한 마지막 이유는 프로세스들과 프로세스가 요청 및 할당받은 자원이 원의 형태를 이루었기 때문이다.
        - 다시 말해, 자원 할당 그래프가 원의 형태로 그려지면 교착 상태가 발생할 수 있다.
        - 이렇게 프로세스들이 원의 형태로 자원을 대기하는 것을 **원형 대기(circular wait)** 라고 한다.
        > 자원 할당 그래프가 원의 형태로 그려지면 교착 상태가 발생할 '수' 있다고 표현한 이유가 있다. 자원 할당 그래프가 원의 형태를 띄지 않는다면 교착 상태는 발생하지 않으나, 원의 형태를 띈다고 해서 반드시 교착 상태가 발생하는 것은 아니다.

---