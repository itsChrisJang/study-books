# Chapter 12 프로세스 동기화
## 12-1. 동기화란
- 동시다발적으로 실행되는 프로세스들은 공동의 목적을 올바르게 수행하기 위해 서로 협력하며 영향을 주고 받기도 한다.
  - 이렇게 협력하여 실행되는 프로세스들은 실행 순서와 자원의 일관성을 보장해야 하기에 반드시 **동기화(synchronization)** 이 되어야 한다.

### 동기화의 의미
- 동시다발적으로 실행되는 많은 프로세스는 서로 데이터를 주고받으며 협력하며 실행될 수 있다.
  - 예를 들어 워드 프로세서에는 사용자로부터 입력을 받는 프로세스와 입력한 내용의 맞춤법을 검사하는 프로세스, 입력한 내용을 화면에 출력해 주는 프로세스 등이 있다.
  - 이 프로세스들은 각기 다른 독립적인 프로세스이지만 공동의 목표를 위해 서로 협력하는 존재이다.
- 이렇게 협력적으로 실행되는 프로세스들은 아무렇게나 마구 동시에 실행해서는 안된다.
  - 올바른 실행을 위해서는 **동기화** 가 필수이다.
- 프로세스 동기화란?
  - '정보 통신 분야에서의 동기화란 작업들 사이에의 수행 시기를 맞추는 것'
  - **프로세스들 사이의 수행 시기를 맞추는 것을 의미한다.**
    - 실행 순서 제어: 프로세스를 올바른 순서대로 실행하기
    - 상보 배제: 동시에 접근해서는 안 되는 자원에 하나의 프로세스만 접근하게 하기
> - 프로세스뿐만 아니라 스레드도 동기화 대상이다.
> - 정확히 말하면 실행의 흐름을 갖는 모든 것은 동기화의 대상이다.
 
#### 첫째, 실행 순서 제어를 위한 동기화에 대해 알아보자.
- Writer라는 프로세스와 Reader라는 프로세스가 동시에 실행 중이라고 가정해보자.
- Writer 프로세스는 Book.txt 파일에 값을 저장하는 프로세스이고, Reader 프로세스는 Book.txt 파일에 저장된 값을 읽어 들이는 프로세스라고 가정하자.
  - 이 두 프로세스는 무작정 아무 순서대로 실행되면 안된다.
    - Reader 프로세스는 Writer 프로세스 실행히 끝나야 비로소 실행할 수 있기 때문이다.
  - 즉, Reader 프로세스는 'Book.txt 안에 값이 존재한다.'는 특정 조건이 만족되어야만 실행을 이어나갈 수 있다.
  - 이렇게 동시에 실행되는 프로세스를 올바른 순서대로 실행하는 것이 첫 번째 프로세스 동기화이다.

#### 둘째, 상호 배제를 위한 동기화에 대해 알아보자.
- **상호 배제(mutual exclusion)** 는 공유가 불가능한 자원의 동시 사용을 피하기 위해 사용하는 알고리즘이다.
- 예시
  - 계좌에 10만 원이 저축되어 있다고 가정하자.
  - 프로세스 A는 현재 저축한 금액에 2만 원을 넣는 프로세스, 프로세스 B는 현재 저축된 금액에 5만 원을 넣는 프로세스이다.
    - 프로세스 A가 실행되는 과정
      1. 계좌의 잔액을 읽어 들인다.
      2. 읽어 들인 잔액에 2만 원을 더한다.
      3. 더한 값을 저장한다.
    - 프로세스 B가 실행되는 과정
      1. 계좌의 잔액을 읽어 들인다.
      2. 읽어 들인 잔액에 5만 원을 더한다.
      3. 더한 값을 저장한다.
  - 프로세스 A와 B가 동시에 실행되었다고 가정해보자.
    - **동기화가 이루어지지 않은 경우**
      - 최종 잔액이 12만 원이 될 수도, 15만 원이 될 수도, 17만 원이 될 수도 있다.
      - 왜 이런 일이 발생할까?
        - A와 B는 '잔액'이라는 데이터를 동시에 사용하는데, A가 끝나기도 전에 B가 잔액을 읽어 버렸기 때문이다.
      - A와 B를 올바르게 실행하기 위해서는 한 프로세스가 잔액에 접근했을 때 다른 프로세스는 기다려야 한다.
    - **동기화가 이루어진 경우**
      - 최종 잔액이 17만 원이 된다.
      - 이렇게 동시에 접근해서는 안 되는 자원에 동시에 접근하지 못하게 하는 것이 **상호 배제를 위한 동기화** 이다.

### 생산자와 소비자 문제
- 생산자와 소비자 문제는 물건을 계속해서 생산하는 프로세스인 생산자와 물건을 계속해서 소비하는 프로세스인 소비자로 이루어져 있다.
- 생상자와 소비자는 '총합'이라는 데이터를 공유하고 있다.
  - 생산자는 버퍼에 물건을 넣은 후, 물건의 총합에 해당하는 변수를 1 증가시키고, 소비자는 버퍼에 물건을 빼낸 후 물건의 총합에 해당하는 변수를 1 감소시킨다.
- 총합을 10으로 가정해보고 생산자를 100,000번, 소비자를 100,000번 동시에 실행해 보자.
```text
총합 = 10

생산자 () {
    버퍼에 데이터 삽입
    '총합' 변수 1 증가
}

소비자 () {
    버퍼에 데이터 빼내기
    '총합' 변수 1 감소
}
```
  - 언뜻 보기에는 코드에는 아무런 문제가 없어 보인다.
  - 총합 변수가 계속 10개로 머물러 있을 것으로 예상된다.
    - 하지만 막상 생산자와 소비자를 동시에 실행해 보면 예상치 못한 결과를 받을 수 있다.
    - 총합이 10이 아닌 다른 수가 되거나 실행 중 오류가 나기도 한다.
    - 이는 생산자 프로세스와 소비자 프로세스가 제대로 동기화되지 않았기 때문에 발생한 문제이다.
    - 생산자와 소비자는 '총합'이라는 데이터를 동시에 사용하는데, 위 예시에서는 소비자가 생산자의 작업이 끝나기도 전에 총합을 수정했고, 생산자가 소비자의 작업이 끝나기도 전에 총합을 수정했기 때문에 엉뚱한 결과가 발생한 것이다.
    - **즉, 계좌 잔액 문제와 생산자 소비자 문제는 동시에 접근해서는 안 되는 자원에 동시에 접근했기에 발생한 문제이다.

### 공유 자원과 임계 구역
- 위의 예시에서 동시에 실행되는 프로세스들은 전역 변수 '잔액', '총합'이라는 공동의 자원을 두고 작업했다.
  - 이러한 자원을 **공유 자원(shared resource)** 라고 한다.
  - 공유 자원은 전역 변수가 될 수도 파일이 될 수도 있고, 입출력장치, 보조기억장치가 될 수 있다.
- 이 공유 자원 중에는 두 개 이상의 프로세스를 동시에 실행하면 문제가 발생하는 자원이 있다.
  - 이렇게 동시에 실행하면 문제가 발생하는 자원에 접근하는 코드 영역을 **임계 구역(critical section)** 이라고 한다.
  - 두 개 이상의 프로세스가 임계 구역에 진입하고자 하면 둘 중 하나는 대기해야 한다.
    - 임계 구역에 먼저 진입한 프로세스의 작업이 마무리되면 그제서야 비로소 기다렸던 프로세스가 임계 구역에 진입한다.
- 임계 구역은 두 개 이상의 프로세스가 동시에 실행되면 안 되는 영역이지만, 잘못된 실행으로 인해 여러 프로세스가 동시 다발적으로 임계 구역의 코드를 실행하여 문제가 발생하는 경우가 있다.
  - 이를 **레이스 컨디션(race condition)** 이라고 한다.
  - 레이스 컨디션이 발생하면 계좌 잔액 문제나 생산자와 소비자 문제처럼 데이터의 일관성이 깨지는 문제가 발생한다.
- 레이스 컨디션이 발생하는 근본적인 문제
  - 가령 생성자 소비자 문제에서 '총합을 1 증가시킨다' 혹은 '총합을 1 감소시킨다'라는 코드를 고급 언어 한 줄로 작성할 수 있지만, 이는 컴퓨터 내부에서 대략 여러 줄의 저급 언어로 변환되어 실행된다.
  - 컴퓨터는 고급 언어가 아닌 저급 언어를 실행하기 때문에 여러 줄의 저급 언어로 변환된 고급 언어 한 줄을 실행하는 과정에서 문맥 교환이 일어날 수 있다.
  - 이때, 상호 배제를 위한 동기화는 이와 같은 일이 발생하지 않도록 두 개 이상의 프로세스가 임계 구역에 동시에 접근하지 못하도록 관리하는 것을 의미한다.
- 운영체제는 이러한 임계 구역 문제를 아래 세 가지 원칙 하에 해결한다. 달리 말해 상호 배제를 위한 동기화를 위해서는 아래 세 가지 원칙이 반드시 지켜져야만 한다.
  - **상호 배제(mutual exclusion)**
    - 한 프로세스가 임계 구역에 진입했다면 다른 프로세스는 임계 구역에 들어올 수 없다.
  - **진행(progress)**
    - 임계 구역에 어떤 프로세스도 진입하지 않았다면 임계 구역에 진입하고자 하는 프로세스는 들어갈 수 있어야 한다.
  - **유한 대기(bounded waiting)**
    - 한 프로세스가 임계 구역에 진입하고 싶다면 그 프로세스는 언젠가는 임계 구역에 들어올 수 있어야 한다.(임계 구역에 들억오기 위해 무한정 대기해서는 안 된다.)

---