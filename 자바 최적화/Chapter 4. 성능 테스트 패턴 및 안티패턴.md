# Chapter 4. 성능 테스트 패턴 및 안티패턴

다양한 종류의 테스트를 소개하고 유형별 베스트 프랙티스를 공부해보겠습니다.

## 4.1 성능 테스트 유형
성능 테스트를 나쁜 의도로, 부실하게 수행하는 경우가 많습니다.    
원인은 제각각이겠지만 대개 성능 분석의 본질을 이해하지 못한 채 "그래도 뭐라도 하는 게 아무것도 안 하는 것보단 낫지 않나"라고 믿기 때문입니다.

가장 흔히 저지르는 실수는 구체적인 내용을 정하지 않고 뭉뚱그려 '성능 테스트'를 운운하는 겁니다.

성능 테스트는 유형별로 그 목표가 거의 독립적(약간 중첩되는 부분도 있지만)입니다.

- 지연 테스트(Latency test)
  - 종단 트랜잭션에 걸리는 시간은?
- 처리율 테스트(Throughput test)
  - 현재 시스템이 처리 가능한 동시 트랜잭션 개수는?
- 부하 테스트(Load test)
  - 특정 부하를 시스템이 감당할 수 있는가?
- 스트레스 테스트(Stress test)
  - 이 시스템의 한계점은 어디까지인가?
- 내구성 테스트(Endurance test)
  - 시스템을 장시간 실행할 경우 성능 이상 증상이 나타나는가?
- 용량 계획 테스트(Capacity planning test)
  - 리소스를 추가한 만큼 시스템이 확장되는가?
- 저하 테스트(Degradation)
  - 시스템이 부분적으로 실패할 경우 어떤 일이 벌어지나?

### 4.1.1 지연 테스트(Latency test)
지연 테스트는 가장 일반적인 성능 테스트입니다.    
'고객이 트랜잭션(또는 페이지 로딩)'을 얼마나 오래 참고 기다려야 하는지' 측정한 시스템 수치는 경영진들이 피부로 느끼는 관심사입니다.   
이 테스트를 통해 답변하려는 질문이 너무 정량적이고 명확한 나머지 다른 종류의 성능 테스트로 밝히려는 정량적 질문을 식별한 필요성마저 흐릿하게 만들 수 있습니다.

그러나 아무리 단순한 케이스라도 지연 테스트에는 조심스럽게 취급해야 할 미묘한 부분이 있습니다.    
단순 평균값은 애플리케이션의 요청 응답성을 측정하는 지표로 별로 소용이 없다는 사실도 주의해야 합니다.

### 4.1.2 처리율 테스트(Throughput test)
처리율 테스트는 그다음으로 일반적인 성능 테스트입니다.   
어떤 측면에서 처리율은 지연과 동등한 개념이라고 볼 수 있습니다.

이를테면, 지연 테스트를 수행할 때에는 계속 진행 중인 동시 트랜잭션을 반드시 명시(그리고 제어)해야 합니다.

마찬가지로, 처리율 역시 지연을 모니터링하면서 테스트합니다.   
지연 분포가 갑자기 변하는 점, 즉 사실상 한계점(변곡점)이 바로 '최대 처리율'입니다.   
스트레스 테스트의 목표는 이런 현상이 발생하는 지점과 그 시점의 부하 수준을 포착하는 것입니다.

반면, 처리율 테스트는 시스템 성능이 급락하기 직전, 최대 처리율 수치를 측정하는 것이 목표입니다.

### 4.1.3 부하 테스트(Load test)
부하 테스트는 처리율 테스트(또는 스트레스 테스트)와는 조금 다릅니다.   
'시스템이 이 정도 부하를 견딜 수 있을까?, 없을까?' 하는 예/아니오 질문에 답을 구하는 과정입니다.

가령 신규 고객을 유치하거나 새로운 시장에 진출하기 전, 애플리케이션 트래픽이 상당할 것으로 예상되는 특정 비즈니스 이벤트에 대비하기 위해 부하 테스트를 수행합니다.

### 4.1.4 스트레스 테스트(Stress test)
스트레스 테스트는 시스템 여력이 어느 정도인지 알아보는 수단입니다.     
보통 일정한 수준의 트랜잭션, 즉 특정 처리율(현재로서 최대치)을 시스템에 계속 걸어놓습니다.   

측정값이 나빠지기 시작하기 직전의 값이 바로 최대 처리율입니다.

### 4.1.5 내구성 테스트(Endurance test)
메모리 누수, 캐시 오염, 메모리 단편화(CMS 가비지 수집기를 쓰는 애플리케이션은 결국 언젠가 CMF가 발생합니다.) 등 한참 시간이 지나고 나서야 드러나는 문제점도 있습니다.

대개 이런 종류의 문제는 내구 테스트로 감지합니다.

평균 사융률로 시스템에 일정 부하를 계속 주며 모니터링하다가 갑자기 리소스가 고갈되거나 시스템이 깨지는 지점을 찾습니다.

내구 테스트는 빠른 응답을 요구하는 시스템에서 많이 합니다.    
풀 GC 사이클이 일으키는 STW 시간조차 허용되지 않습니다.

### 4.1.6 용량 계획 테스트(Capacity planning test)
용량 계획 테스트는 스트레스 테스트와 여러므로 비슷하지만, 분명히 구분되는 차이점이 있습니다.    
스트레스 테스트는 현재 시스템이 어느 정도 부하를 버틸 수 있는지 알아보는 반면, 용량 계획 테스트는 업그레이드한 시스템이 어느 정도 부하를 감당할 수 있을지 미리 내다보는 것입니다.

따라서 어떤 이벤트나 위협 요소에 대응하는 것이 아니라, 예정된 계획의 일부분으로 실행하는 경우가 많습니다.

### 4.1.7 저하 테스트(Degradation)
저하 테스트는 부분 실패 리스트라고도 합니다.   

이 책에서 저하 테스트는 복원 테스트 하나만 생각하면 됩니다.   
저하 테스트는 기본적으로 평상시 운영 환경과 동등한 수준의 부하를 시스템에 가하는 도중, 어떤 컴포넌트나 전체 서브시스템이 갑자기 능력을 상실하는 시점에 벌어지는 일들을 확인합니다.   
예를 들어, 애플리케이션 서버 클러스터에서 순간적으로 멤버가 사라지거나, DB 서버에서 RAID 디스크가 빠져버리든지, 네트워크 대역폭이 갑자기 줄어드는 경우를 떠올려볼 수 있습니다. 

저하 테스트 도중 눈여겨 봐야 할 측정값은 트랜잭션 지연 분포와 처리율입니다.

부분 실패 테스트 중에는 카오스 멍키(혼돈의 원숭이)라는 하위 유형이 있습니다.    
카오스 멍키의 요지는, 진짜 복원성 있는 아키텍처에서는 어느 한 컴포넌트가 잘못돼도 다른 컴포넌트까지 연쇄적으로 무너뜨리면서 전체 시스템에 부정적 영향을 끼치는 일은 없어야 한다는 것입니다.

### 4.2 기본 베스트 프랙티스
